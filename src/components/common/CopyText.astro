---
import { Icon } from 'astro-icon/components';
import { twMerge } from 'tailwind-merge';

interface Props {
  text: string;
  class?: string;
  iconClass?: string;
  showIcon?: boolean;
}

const {
  text,
  class: className = '',
  iconClass = '',
  showIcon = true,
  ...rest
} = Astro.props as Props;

const containerClasses = twMerge(
  'inline-flex items-center gap-2 group cursor-pointer hover:bg-gray-100 rounded px-2 py-1 transition-colors',
  className
);

const iconClasses = twMerge(
  'w-4 h-4 transition-colors text-gray-500 group-hover:text-primary',
  iconClass
);
---

<button
  type="button"
  class={containerClasses}
  data-copy-text={text}
  aria-label="Copy to clipboard"
  title="Click to copy"
  {...rest}
>
  <span class="copy-text-content select-all">{text}</span>
  {showIcon && (
    <span class="copy-icon-wrapper">
      <Icon name="tabler:copy" class={iconClasses} />
      <Icon name="tabler:check" class={twMerge(iconClasses, 'hidden text-green-500')} />
    </span>
  )}
</button>

<!-- Toast Notification -->
<div
  id="copy-toast"
  class="fixed bottom-6 right-6 bg-green-500 text-white px-5 py-3 rounded-lg shadow-lg items-center gap-2 z-[9999] opacity-0 translate-y-2 transition-all duration-300 pointer-events-none hidden"
>
  <Icon name="tabler:check" class="w-5 h-5 text-white" />
  <span class="font-medium text-sm">Скопировано!</span>
</div>

<script>
  function showToast(message: string) {
    const toast = document.getElementById('copy-toast');
    if (!toast) return;

    const textElement = toast.querySelector('span');
    if (textElement) {
      textElement.textContent = message;
    }

    toast.classList.remove('hidden');
    toast.classList.add('flex');
    // Trigger reflow to ensure transition works
    void toast.offsetHeight;
    toast.classList.add('show');

    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        toast.classList.remove('flex');
        toast.classList.add('hidden');
      }, 300);
    }, 2000);
  }

  function initCopyButtons() {
    const copyButtons = document.querySelectorAll('[data-copy-text]');

    copyButtons.forEach((button) => {
      const copyIcon = button.querySelector('[data-icon="tabler:copy"]');
      const checkIcon = button.querySelector('[data-icon="tabler:check"]');
      const textToCopy = button.getAttribute('data-copy-text');

      button.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        if (!textToCopy) return;

        try {
          await navigator.clipboard.writeText(textToCopy);

          // Show success feedback on icon
          if (copyIcon && checkIcon) {
            copyIcon.classList.add('hidden');
            checkIcon.classList.remove('hidden');

            // Reset after 2 seconds
            setTimeout(() => {
              copyIcon.classList.remove('hidden');
              checkIcon.classList.add('hidden');
            }, 2000);
          }

          // Show toast notification
          showToast('Скопировано!');
        } catch (err) {
          console.error('Failed to copy text:', err);
          showToast('Failed to copy!');
        }
      });
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initCopyButtons);

  // Re-initialize after navigation (for Astro view transitions)
  document.addEventListener('astro:page-load', initCopyButtons);
</script>

<style>
  #copy-toast.show {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }
</style>
