---
import Image from '../common/Image.astro';
import Modal from '../common/Modal.astro';

export interface GalleryItemProps {
  imageUrl: string;
  alt?: string;
}

const { imageUrl, alt = '' } = Astro.props as GalleryItemProps;

const modalId = `gallery-modal-${crypto.randomUUID()}`;
const openLabel = alt ? `Open image preview: ${alt}` : 'Open image preview';
---

<div class="relative w-full gallery-item-container">
  <!-- Loading Spinner -->
  <div
    class="gallery-loader absolute inset-0 flex items-center justify-center bg-gray-200 dark:bg-gray-800 rounded-xl"
    aria-hidden="true"
  >
    <div class="spinner"></div>
  </div>

  <button
    type="button"
    class="gallery-image-button block w-full border-none p-0 cursor-pointer rounded-xl overflow-hidden bg-transparent transition-transform duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-primary focus-visible:outline-offset-4 opacity-0"
    data-modal-open={modalId}
    aria-label={openLabel}
  >
    <Image
      src={imageUrl}
      alt={alt}
      class="gallery-image gallery-item-blured block w-full h-full object-cover transition-transform duration-200 group-hover:scale-105 focus-visible:scale-105"
    />
  </button>

  <Modal id={modalId} title={' '}>
    <Image src={imageUrl} alt={alt} class="block gallery-item-blured w-full h-auto rounded-xl object-contain" />
  </Modal>
</div>

<style>
  .gallery-item-blured {
    filter: blur(20px);
    transition: filter 0.3s ease-out;
  }

  .gallery-item-container {
    min-height: 200px;
  }

  .gallery-loader {
    transition: opacity 0.3s ease-out;
  }

  .gallery-loader.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .gallery-image-button {
    transition: opacity 0.3s ease-in;
  }

  .gallery-image-button.loaded {
    opacity: 1;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  :global(.dark) .spinner {
    border-color: rgba(255, 255, 255, 0.1);
    border-top-color: #60a5fa;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const galleryItems = document.querySelectorAll('.gallery-item-container');

    galleryItems.forEach((container) => {
      const loader = container.querySelector('.gallery-loader');
      const button = container.querySelector('.gallery-image-button');
      const img = container.querySelector('.gallery-image') as HTMLImageElement;

      if (!loader || !button || !img) return;

      const handleImageLoad = () => {
        loader.classList.add('hidden');
        button.classList.add('loaded');
      };

      if (img.complete && img.naturalHeight !== 0) {
        // Image already loaded
        handleImageLoad();
      } else {
        // Wait for image to load
        img.addEventListener('load', handleImageLoad);
        img.addEventListener('error', () => {
          // Hide loader even on error
          loader.classList.add('hidden');
          button.classList.add('loaded');
        });
      }
    });
  });
</script>
