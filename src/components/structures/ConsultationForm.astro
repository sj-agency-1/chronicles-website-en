---
import Input from '~/components/common/Input.astro';
import Select from '~/components/common/Select.astro';
import Textarea from '~/components/common/Textarea.astro';
import Button from '../common/Button.astro';

const services = [
  'Экспресс-диагностика и стратегические сессии',
  'Комплексный отраслевой аудит',
  'Проекты антикризисного управления',
  'Персональное менторство и стратегическое сопровождение',
];

let consultationSubmitUrl = 'https://n8n.georgeparkdev.com/webhook-test/submit-consultation-request';
if (import.meta.env.PROD) {
  consultationSubmitUrl = 'https://n8n.georgeparkdev.com/webhook/submit-consultation-request';
}
---

<form id="consultation-form" method="post" action={consultationSubmitUrl} class="flex flex-col gap-4">
  <Input name="consultation-form__name" label="Ваше ФИО" placeholder="Введите ваше ФИО" required />
  <Input name="consultation-form__email" label="Email" placeholder="Введите ваш Email" type="email" required />
  <Select
    name="consultation-form__service"
    label="Услуга (необязательно)"
    placeholder="Выберите услугу из списка"
    options={services}
  />
  <Textarea
    name="consultation-form__details"
    label="Дополнительные детали (необязательно)"
    placeholder="Опишите вашу ситуацию или задачу подробнее..."
    maxlength={2048}
  />
  <div>
    <div id="consultation-form__form-status" class="mb-4 hidden rounded p-4"></div>
  </div>
  <Button
    id="consultation-form__submit-button"
    class="max-w-fit"
    text="Отправить заявку"
    variant="primary"
    size="small"
    type="button"
    buttonType="submit"
  />
</form>

<script>
  const form = document.getElementById('consultation-form') as HTMLFormElement;
  const submitButton = document.getElementById('consultation-form__submit-button') as HTMLButtonElement;
  const formStatus = document.getElementById('consultation-form__form-status') as HTMLDivElement;

  function showMessage(message: string, isError: boolean = false) {
    formStatus.textContent = message;
    formStatus.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
    if (isError) {
      formStatus.classList.add('bg-red-100');
      formStatus.classList.add('text-red-700');
    } else {
      formStatus.classList.add('bg-green-100');
      formStatus.classList.add('text-green-700');
    }
  }

  function validateForm(): boolean {
    // Get all required fields
    const requiredFields = form.querySelectorAll('[required]') as NodeListOf<HTMLInputElement | HTMLSelectElement>;
    let isValid = true;

    // Check each required field
    requiredFields.forEach((field) => {
      if (!field.value.trim()) {
        isValid = false;
        field.classList.add('border-red-500');
      } else {
        field.classList.remove('border-red-500');
      }
    });

    return isValid;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validate form
    if (!validateForm()) {
      showMessage('Пожалуйста, заполните все обязательные поля.', true);
      return;
    }

    try {
      // Disable submit button
      submitButton.disabled = true;
      submitButton.textContent = 'Отправка...';

      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        throw new Error('Network response was not ok');
      }

      // Show success message
      showMessage('Ваша заявка успешно отправлена! Я свяжусь с вами в течение 48 часов.');
      form.reset();
    } catch (error: unknown) {
      // Show error message
      console.error('Form submission error:', error);
      showMessage('Произошла ошибка при отправке формы. Пожалуйста, попробуйте снова.', true);
    } finally {
      // Re-enable submit button
      submitButton.disabled = false;
      submitButton.textContent = 'Отправить заявку';
    }
  });
</script>
