---
import { FORMS_URLS } from 'astrowind:config';
import Input from '~/components/common/Input.astro';
import Select from '~/components/common/Select.astro';
import Textarea from '~/components/common/Textarea.astro';
import Button from '../common/Button.astro';

const services = [
  'Online Consultation',
  'Business Audit',
  'Mentorship',
  'Personal Branding',
  'Meeting Consultation',
  'On-site Consultation',
];

let consultationSubmitUrl = FORMS_URLS.consultationFormTestUrl;
if (import.meta.env.PROD) {
  consultationSubmitUrl = FORMS_URLS.consultationFormUrl;
}
---

<form id="consultation-form" method="post" action={consultationSubmitUrl} class="flex flex-col gap-4">
  <Input name="consultation-form__name" label="Your Full Name" placeholder="Enter your full name" required />
  <Input name="consultation-form__email" label="Email" placeholder="Enter your email" type="email" required />
  <Select
    name="consultation-form__service"
    label="Service (optional)"
    placeholder="Select a service from the list"
    options={services}
  />
  <Textarea
    name="consultation-form__details"
    label="Additional Details (optional)"
    placeholder="Describe your situation or task in more detail..."
    maxlength={2048}
  />
  <div>
    <div id="consultation-form__form-status" class="mb-4 hidden rounded p-4"></div>
  </div>
  <Button
    id="consultation-form__submit-button"
    class="max-w-fit"
    text="Submit Request"
    variant="primary"
    size="small"
    type="button"
    buttonType="submit"
  />
</form>

<script>
  const form = document.getElementById('consultation-form') as HTMLFormElement;
  const submitButton = document.getElementById('consultation-form__submit-button') as HTMLButtonElement;
  const formStatus = document.getElementById('consultation-form__form-status') as HTMLDivElement;

  function showMessage(message: string, isError: boolean = false) {
    formStatus.textContent = message;
    formStatus.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
    if (isError) {
      formStatus.classList.add('bg-red-100');
      formStatus.classList.add('text-red-700');
    } else {
      formStatus.classList.add('bg-green-100');
      formStatus.classList.add('text-green-700');
    }
  }

  function validateForm(): boolean {
    // Get all required fields
    const requiredFields = form.querySelectorAll('[required]') as NodeListOf<HTMLInputElement | HTMLSelectElement>;
    let isValid = true;

    // Check each required field
    requiredFields.forEach((field) => {
      if (!field.value.trim()) {
        isValid = false;
        field.classList.add('border-red-500');
      } else {
        field.classList.remove('border-red-500');
      }
    });

    return isValid;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validate form
    if (!validateForm()) {
      showMessage('Please fill in all required fields.', true);
      return;
    }

    try {
      // Disable submit button
      submitButton.disabled = true;
      submitButton.textContent = 'Sending...';

      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        throw new Error('Network response was not ok');
      }

      // Show success message
      showMessage('Your request has been successfully sent! I will contact you within 48 hours.');
      form.reset();
    } catch (error: unknown) {
      // Show error message
      console.error('Form submission error:', error);
      showMessage('An error occurred while submitting the form. Please try again.', true);
    } finally {
      // Re-enable submit button
      submitButton.disabled = false;
      submitButton.textContent = 'Submit Request';
    }
  });
</script>
