---
import { FORMS_URLS } from 'astrowind:config';
import Input from '~/components/common/Input.astro';
import Select from '~/components/common/Select.astro';
import Textarea from '~/components/common/Textarea.astro';
import FileUpload from '~/components/common/FileUpload.astro';
import Button from '../common/Button.astro';

const vacancies = [
  'Financial Auditor',
  'Corporate Law Lawyer',
  'Intellectual Property Lawyer',
  'Certified Patent Attorney',
  'Online Assistant (Consultant)',
];

let vacancySubmitUrl = FORMS_URLS.vacancyFormTestUrl;
if (import.meta.env.PROD) {
  vacancySubmitUrl = FORMS_URLS.vacancyFormUrl;
}
---

<form id="vacancies-form" method="post" action={vacancySubmitUrl} class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <Input name="vacancies-form__name" label="Your Full Name" placeholder="Enter your full name" required />
  <Input
    name="vacancies-form__whatsapp"
    label="WhatsApp Number"
    placeholder="+1XXXXXXXXXX"
    type="tel"
    pattern="^\+\d+$"
    required
  />
  <Input name="vacancies-form__email" label="Email" placeholder="Enter your email" type="email" required />
  <Select
    name="vacancies-form__vacancy"
    label="Vacancy"
    placeholder="Select a vacancy from the list"
    options={vacancies}
    required
  />
  <Textarea name="vacancies-form__about" label="About Yourself" placeholder="Write something about yourself" />
  <FileUpload
    name="vacancies-form__resume"
    centerText="Upload your resume"
    accept=".pdf,.docx"
    maxSize={5 * 1024 * 1024}
  />
  <div class="col-span-1 md:col-span-2">
    <div id="vacancies-form__form-status" class="mb-4 hidden rounded p-4"></div>
  </div>
  <Button
    id="vacancies-form__submit-button"
    class="col-span-1 md:col-span-2 max-w-fit"
    text="Submit"
    variant="primary"
    size="small"
    type="button"
    buttonType="submit"
  />
</form>

<script>
  const form = document.getElementById('vacancies-form') as HTMLFormElement;
  const submitButton = document.getElementById('vacancies-form__submit-button') as HTMLButtonElement;
  const formStatus = document.getElementById('vacancies-form__form-status') as HTMLDivElement;

  function showMessage(message: string, isError: boolean = false) {
    formStatus.textContent = message;
    formStatus.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
    if (isError) {
      formStatus.classList.add('bg-red-100');
      formStatus.classList.add('text-red-700');
    } else {
      formStatus.classList.add('bg-green-100');
      formStatus.classList.add('text-green-700');
    }
  }

  function validateForm(): boolean {
    // Get all required fields
    const requiredFields = form.querySelectorAll('[required]') as NodeListOf<HTMLInputElement | HTMLSelectElement>;
    let isValid = true;

    // Check each required field
    requiredFields.forEach((field) => {
      if (!field.value.trim()) {
        isValid = false;
        field.classList.add('border-red-500');
      } else {
        field.classList.remove('border-red-500');
      }
    });

    return isValid;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validate form
    if (!validateForm()) {
      return;
    }

    try {
      // Disable submit button
      submitButton.disabled = true;
      submitButton.textContent = 'Отправка...';

      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        throw new Error('Network response was not ok');
      }

      // Show success message
      showMessage('Ваша заявка успешно отправлена!');
      form.reset();
    } catch (error: unknown) {
      // Show error message
      console.error('Form submission error:', error);
      showMessage('Form submission failed. Please try again.', true);
    } finally {
      // Re-enable submit button
      submitButton.disabled = false;
      submitButton.textContent = 'Отправить';
    }
  });
</script>
